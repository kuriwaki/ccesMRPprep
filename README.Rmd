---
title: "Portable Routines for Preparing CCES and ACS data for MRP"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Cite as:

* Shiro Kuriwaki (2020). ccesMRPprep: Functions to Prepare CCES data for MRP. R package. <https://www.github.com/kuriwaki/ccesMRPprep>


### Purpose and Contribution

Multi-level Regression and Post-stratification is an increasingly popular method for analyzing surveys, and can be implemented on public datasets such as the [CCES](https://cces.gov.harvard.edu/) and ACS. However, there are considerable upfront costs in preparing the data, recoding values and generating post-stratification frames so data can be matched.

This package provides data loading, processing, and formatting functions for a particular task: using _CCES data_ for MRP. Its key contributions are functions that are calibrated to a consistent syntax, lookup tables and value-key pairs of data that are based upon a careful reading of data sources, and data loading functions that use APIs to reduce the dependency on downloading large files. Model fitting and visualization of MRP itself is handled elsewhere. This package is focused on the preparation to get there. 
   
   
```{r, echo = TRUE, message = FALSE}
# remotes::install_github("kuriwaki/ccesMRPprep")
library(ccesMRPprep)
library(tidyverse)
```

See the vignettes for more long-form documentation and explanation of the nature of the data. Otherwise, each function and built-in data provides documentation as well. An overview of the workflow is below.


## Workflow

_**Step 1.** Loading CCES data_

All CCES data can be downloaded directly from dataverse, using the development version of the `dataverse` R package.  Once you set your dataverse API token, the function `get_cces_dv` will make this quick and simple. 


```{r, eval = FALSE}
ccc <- get_cces_dv("cumulative")
```

We will use a built-in sample of 1,000 observations for illustration (see `?ccc_samp`).

```{r}
ccc_samp
```



_**Step 2.** Cleaning CCES data_

The CCES cumulative dataset is already harmonized and cleaned, but values must be recoded so that they later match with the values of th ACS. I have created key-value pairings for the main demographic variables. The wrapper function expects a CCES cumulative dataset and recodes.

See `?get_cces_question` for how to get the _outcome_ data, which is a single column from another CCES dataset. This still relies on a flat file being pre-downloaded (via `?get_cces_dv`. 

```{r}
ccc_std <- ccc_std_demographics(ccc_samp)
```



_**Step 3.** Preparing the brms function_

We presume the formula will be used in brms. Currently we support binary outcomes. This can be modeled as a binomial, which in brms is of the form

```{r}
fm_brm <- yes | trials(n_responses) ~  age + gender + educ + pct_trump + (1|cd)
```


A prior could be specified here as well, but this is not strictly necessary and can be defined when fitting the model. 


_**Step 4.** Collapsing the CCES data_

For speed, we collapse the individual-level data where each outcome is binary to a count dataset where each row is a cell (with a trial and success value). This form also makes drawing posteriors much easier in the next step. We use `?build_counts` for this, which takes a individual-level dataset (built from `?ccc_std_demographics`, or further passed through `?ccces_join_slim` for all relevant outcomes and predictors).

```{r}
# fake outcome data - must be called "response"
set.seed(02138)
ccc_samp_std <- ccc_samp %>% 
   mutate(response = sample(c("For", "Against"), size = n(), replace = TRUE)) %>% 
   ccc_std_demographics()

ccc_samp_out <- build_counts(ccc_samp_std,
                             "yes | trials(n_response) ~ age + gender + educ")

ccc_samp_out
```


_**Step 5.** Prepare a post-stratification table, after preparing ACS data_

We provide wrappers around the great [tidycensus](https://walker-data.com/tidycensus/) package
that produces ACS data and post-stratification tables from the ACS. A considerable amount of
lookup tables internally will pull out the apporpriate CD-level counts and label them
so that they match up with CCES keys. District-level information, which is not necessary ACS data (e.g. election outcomes) must be supplied here as well/

```{r, eval = FALSE}

 acs_tab <- get_acs_cces(
              varlist = acscodes_age_sex_educ,
              varlab_df = acscodes_df,
             .year = 2018)

 poststrat <-  get_poststrat(acs_tab, cd_info_2018, fm_brm)
```

_**Final Output**_

Under this workflow, only three objects are needed to conduct MRP with a brms model:

- The model specification which can be a plain text line of a brms formula (in Step 3)
- The survey data that is formatted via `?build_counts` at the end (in Step 4)
- The poststratification table via `?get_poststrat` (in Step 5).

Together, these uniquely define one MRP model for one operationalization of one question with a particular set of covariates. 


## Related Packages

- <https://github.com/kuriwaki/rcces> has another set of CCES related functions, but these
are either my own personal functions in development (not for production), or specific to 
non-MRP projects.
- <https://github.com/kuriwaki/CCES_district-opinion> is a private package that uses (among others) this package to process large CCES data for MRP at scale. 


## Support

This package is a part of the CCES MRP project, supported by NSF Grant 1926424: [Bayesian analytical tools to improve survey estimates for subpopulations and small areas](https://nsf.gov/awardsearch/showAward?AWD_ID=1926424). The contents are based on collaborations and helpful discussions with Ben Bales, Lauren Kennedy, Mitzi Morris, and Soichiro Yamauchi.
