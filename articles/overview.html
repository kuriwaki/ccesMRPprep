<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow Overview • ccesMRPprep</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Workflow Overview">
<meta property="og:description" content="ccesMRPprep">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ccesMRPprep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/overview.html">Workflow Overview</a>
    </li>
    <li>
      <a href="../articles/derived.html">Derived Variables</a>
    </li>
    <li>
      <a href="../articles/acs.html">ACS Tables to Use for CCES and MRP</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/kuriwaki/ccesMRPprep/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="overview_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Workflow Overview</h1>
            
      
      <small class="dont-index">Source: <a href="http://github.com/kuriwaki/ccesMRPprep/blob/master/vignettes/overview.Rmd"><code>vignettes/overview.Rmd</code></a></small>
      <div class="hidden name"><code>overview.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://www.github.com/kuriwaki/ccesMRPprep">ccesMRPprep</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://haven.tidyverse.org">haven</a></span>)
</pre></div>
<div id="step-1--downloading-cces-data" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1--downloading-cces-data" class="anchor"></a><strong>Step 1.</strong> Downloading CCES data</h2>
<p>All CCES data can be downloaded directly from dataverse, using the development version of the <a href="https://github.com/IQSS/dataverse-client-r"><code>dataverse</code></a> R package. The function <code><a href="../reference/get_cces_dv.html">get_cces_dv()</a></code> will make this quick and simple - you only need to specify the name of the dataset, given in <code><a href="../reference/cces_dv_ids.html">?cces_dv_ids</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># may take about 30 seconds to download</span>
<span class="kw">ccc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cces_dv.html">get_cces_dv</a></span>(<span class="st">"cumulative"</span>)
</pre></div>
<p>Here we will use a built-in sample of 1,000 observations for illustration (see <code><a href="../reference/ccc_samp.html">ccc_samp()</a></code>). In production, you will want to download all 14 datasets to your local directory via a script like <a href="https://github.com/kuriwaki/CCES_district-opinion/blob/master/R/initialize-cces-downloads.R">initialize-cces-downloads.R</a> (still private).</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">ccc_samp</span>
<span class="co">#&gt; # A tibble: 1,000 x 18</span>
<span class="co">#&gt;     year case_id state st    cd    zipcode county_fips  gender   age    race</span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl+l&gt; &lt;dbl&gt; &lt;dbl+l&gt;</span>
<span class="co">#&gt;  1  2006 1005058 Mich… MI    MI-04 48603   26145       2 [Fem…    36 1 [Whi…</span>
<span class="co">#&gt;  2  2006 1006614 Texas TX    TX-18 77040   48201       1 [Mal…    40 3 [His…</span>
<span class="co">#&gt;  3  2006 1009338 Cali… CA    CA-48 92656   06059       1 [Mal…    32 1 [Whi…</span>
<span class="co">#&gt;  4  2006 1088898 Flor… FL    FL-13 34224   12015       2 [Fem…    52 1 [Whi…</span>
<span class="co">#&gt;  5  2006 1090564 Penn… PA    PA-19 17011   42041       2 [Fem…    25 1 [Whi…</span>
<span class="co">#&gt;  6  2006 1093132 Sout… SC    SC-02 29073   45063       2 [Fem…    48 1 [Whi…</span>
<span class="co">#&gt;  7  2006 1093573 Utah  UT    UT-03 84118   49035       2 [Fem…    74 1 [Whi…</span>
<span class="co">#&gt;  8  2006 1105620 Hawa… HI    HI-01 96701   15003       1 [Mal…    37 4 [Asi…</span>
<span class="co">#&gt;  9  2006 1116569 Texas TX    TX-21 78610   48209       2 [Fem…    20 3 [His…</span>
<span class="co">#&gt; 10  2006 1117377 Ohio  OH    OH-07 45502   39023       2 [Fem…    49 1 [Whi…</span>
<span class="co">#&gt; # … with 990 more rows, and 8 more variables: hispanic &lt;dbl+lbl&gt;,</span>
<span class="co">#&gt; #   educ &lt;dbl+lbl&gt;, faminc &lt;dbl+lbl&gt;, marstat &lt;dbl+lbl&gt;, newsint &lt;dbl+lbl&gt;,</span>
<span class="co">#&gt; #   vv_turnout_gvm &lt;dbl+lbl&gt;, voted_pres_16 &lt;dbl+lbl&gt;, economy_retro &lt;dbl+lbl&gt;</span>
</pre></div>
</div>
<div id="step-2--cleaning-cces-data" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2--cleaning-cces-data" class="anchor"></a><strong>Step 2.</strong> Cleaning CCES data</h2>
<p>The CCES cumulative dataset is already harmonized and cleaned, but values must be recoded so that they later match with the values of the ACS. I have created key-value pairings for the main demographic variables. The wrapper function expects a CCES cumulative dataset and recodes.</p>
<p>See <code><a href="../reference/get_cces_question.html">get_cces_question()</a></code> for how to get the <em>outcome</em> data, which is a single column from another CCES dataset. This still relies on a flat file being pre-downloaded (via <code><a href="../reference/get_cces_dv.html">get_cces_dv()</a></code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">ccc_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ccc_std_demographics.html">ccc_std_demographics</a></span>(<span class="kw">ccc_samp</span>)
<span class="co">#&gt; age variable modified to bins. Original age variable is now in age_orig.</span>
</pre></div>
</div>
<div id="step-3--define-a-model-specification" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3--define-a-model-specification" class="anchor"></a><strong>Step 3.</strong> Define a Model Specification</h2>
<p>A formula represents the variables that are in the model, how they are interacted, and which variables are random effects. We presume the formula will be used in brms. Currently we support binary outcomes. This can be modeled as a binomial, which in brms is of the form</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">fm_brm</span> <span class="op">&lt;-</span> <span class="kw">yes</span> <span class="op">|</span> <span class="fu">trials</span>(<span class="kw">n_responses</span>) <span class="op">~</span>  <span class="kw">age</span> <span class="op">+</span> <span class="kw">gender</span> <span class="op">+</span> <span class="kw">educ</span> <span class="op">+</span> <span class="kw">pct_trump</span> <span class="op">+</span> (<span class="fl">1</span><span class="op">|</span><span class="kw">cd</span>)
</pre></div>
<p>A prior could be specified here as well, but this is not strictly necessary and can be defined when fitting the model.</p>
</div>
<div id="step-4--collapsing-the-cces-data" class="section level2">
<h2 class="hasAnchor">
<a href="#step-4--collapsing-the-cces-data" class="anchor"></a><strong>Step 4.</strong> Collapsing the CCES data</h2>
<p>For speed, we collapse the individual-level data where each outcome is binary to a count dataset where each row is a cell (with a trial and success value). This form also makes drawing posteriors much easier in the next step. We use <code><a href="../reference/build_counts.html">build_counts()</a></code> for this, which takes a individual-level dataset (built from <code><a href="../reference/ccc_std_demographics.html">ccc_std_demographics()</a></code>, or further passed through <code><a href="../reference/cces_join_slim.html">cces_join_slim()</a></code> for all relevant outcomes and predictors).</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># fake outcome data - must be called "response"</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">02138</span>)
<span class="kw">ccc_samp_std</span> <span class="op">&lt;-</span> <span class="kw">ccc_samp</span> <span class="op">%&gt;%</span> 
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(response = <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"For"</span>, <span class="st">"Against"</span>), size = <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>(), replace = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span> 
   <span class="fu"><a href="../reference/ccc_std_demographics.html">ccc_std_demographics</a></span>()
<span class="co">#&gt; age variable modified to bins. Original age variable is now in age_orig.</span>

<span class="kw">ccc_samp_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_counts.html">build_counts</a></span>(<span class="kw">ccc_samp_std</span>,
                             <span class="st">"yes | trials(n_response) ~ age + gender + educ"</span>)

<span class="kw">ccc_samp_out</span>
<span class="co">#&gt; # A tibble: 39 x 5</span>
<span class="co">#&gt;    age            gender educ         n_response   yes</span>
<span class="co">#&gt;    &lt;fct&gt;          &lt;fct&gt;  &lt;fct&gt;             &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 18 to 24 years Male   HS or Less            9     5</span>
<span class="co">#&gt;  2 18 to 24 years Male   Some College         12     6</span>
<span class="co">#&gt;  3 18 to 24 years Male   4-Year                3     0</span>
<span class="co">#&gt;  4 18 to 24 years Female HS or Less           19    12</span>
<span class="co">#&gt;  5 18 to 24 years Female Some College         26    11</span>
<span class="co">#&gt;  6 18 to 24 years Female 4-Year                5     2</span>
<span class="co">#&gt;  7 18 to 24 years Female Post-Grad             1     1</span>
<span class="co">#&gt;  8 25 to 34 years Male   HS or Less           10     4</span>
<span class="co">#&gt;  9 25 to 34 years Male   Some College         11     7</span>
<span class="co">#&gt; 10 25 to 34 years Male   4-Year               23    14</span>
<span class="co">#&gt; # … with 29 more rows</span>
</pre></div>
</div>
<div id="step-5--prepare-acs-data-and-poststratification-table" class="section level2">
<h2 class="hasAnchor">
<a href="#step-5--prepare-acs-data-and-poststratification-table" class="anchor"></a><strong>Step 5.</strong> Prepare ACS data and Poststratification Table</h2>
<p>We provide wrappers around the great <a href="https://walker-data.com/tidycensus/">tidycensus</a> package that produces ACS data and post-stratification tables from the ACS. A considerable amount of lookup tables internally will pull out the appropriate CD-level counts and label them so that they match up with CCES keys. District-level information, which is not necessary ACS data (e.g. election outcomes) must be supplied here as well/</p>
<div class="sourceCode" id="cb7"><pre class="downlit">

 <span class="kw">acs_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_acs_cces.html">get_acs_cces</a></span>(
              varlist = <span class="kw">acscodes_age_sex_educ</span>,
              varlab_df = <span class="kw">acscodes_df</span>,
             year = <span class="fl">2018</span>)

 <span class="kw">poststrat</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/get_poststrat.html">get_poststrat</a></span>(<span class="kw">acs_tab</span>, <span class="kw">cd_info_2018</span>, <span class="kw">fm_brm</span>)
</pre></div>
</div>
<div id="final-output" class="section level2">
<h2 class="hasAnchor">
<a href="#final-output" class="anchor"></a><strong>Final Output</strong>
</h2>
<p>Under this workflow, only three objects are needed to conduct MRP with a brms model:</p>
<ol style="list-style-type: decimal">
<li>The model specification which can be a plain text line of a brms formula (in Step 3)</li>
<li>The survey data that is formatted via <code><a href="../reference/build_counts.html">build_counts()</a></code> at the end (in Step 4)</li>
<li>The poststratification table via <code><a href="../reference/get_poststrat.html">get_poststrat()</a></code> (in Step 5).</li>
</ol>
<p>Together, these uniquely define one MRP model for one operationalization of one question with a particular set of covariates.</p>
<p>Another way to draw the data would be to use <code><a href="../reference/get_cces_dv.html">get_cces_dv()</a></code>, use the demographics from the cumulative passed into <code><a href="../reference/ccc_std_demographics.html">ccc_std_demographics()</a></code>, and then merge the outcome from each year’s CCES (e.g. <code><a href="../reference/get_cces_dv.html">get_cces_dv("2016")</a></code>) using <code><a href="../reference/get_cces_question.html">get_cces_question()</a></code>. The year-specific CCES does come with demographics too, but they are not guaranteed to be standardized by this package’s procedures. Use the formula, the standardized cumulative CCES, and a column of outcomes, and the ACS.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.shirokuriwaki.com">Shiro Kuriwaki</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '1a2c0d939f9a70090cf27efbbac5ba52',
    indexName: 'ccesmrpprep',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
