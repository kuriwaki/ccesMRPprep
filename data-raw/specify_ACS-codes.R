library(ccesMRPprep)
library(tidycensus)
library(tidyverse)

# categories in ACS
ages  <- c("18 to 24 years",
           "25 to 34 years",
           "35 to 44 years",
           "45 to 64 years",
           "65 years and over",
           "18 and 19 years",
           "20 to 24 years",
           "25 to 29 years",
           "30 to 34 years",
           "35 to 44 years",
           "45 to 54 years",
           "55 to 64 years",
           "65 to 74 years",
           "75 to 84 years",
           "85 years and over")
education <- c("Less than 9th grade",
               "9th to 12th grade,? no diploma",
               "High school graduate \\(includes equivalency\\)",
               "Some college,? no degree",
               "Some college or associate's degree",
               "Associate's degree",
               "Bachelor's degree",
               "Graduate or professional degree")
races <- c("White alone, not Hispanic or Latino",
           "Hispanic or Latino",
           "Black or African American alone",
           "American Indian and Alaska Native alone",
           "Asian alone",
           "Native Hawaiian and Other Pacific Islander alone",
           "Some other race alone",
           "Two or more races" #,
           # "Two or more races!!Two races including Some other race",
           # "Two or more races!!Two races excluding Some other race, and three or more races"
)

ages_regex  <- as.character(glue("({str_c(ages, collapse = '|')})"))
edu_regex   <- as.character(glue("({str_c(education, collapse = '|')})"))
races_regex <- as.character(glue("({str_c(races, collapse = '|')})"))


# get vars ----
vars_raw <- tidycensus::load_variables(2018, "acs5")

# format these and recode
# to strings ----
vars <- vars_raw %>%
  mutate(variable = name) %>%
  separate(name, sep = "_", into = c("table", "num")) %>%
  select(variable, table, concept, num, label, everything()) %>%
  filter(str_detect(label, "Total")) %>%
  mutate(label = str_remove(label, "Estimate!!Total")) %>%
  mutate(gender = str_extract(label, "(Male|Female)"),
         age = str_extract(label, ages_regex),
         educ = str_extract(label, edu_regex),
         race = coalesce(str_extract(label, regex(races_regex, ignore_case = TRUE)),
                         str_extract(concept, regex(races_regex, ignore_case = TRUE))))

# partition vars to pull
acscodes_age_sex_educ <- vars %>%
  filter(!is.na(gender), !is.na(age), !is.na(educ)) %>%
  filter(str_detect(table, "^B")) %>%
  pull(variable)

acscodes_age_sex_race <- vars %>%
  filter(str_detect(table, "B01001[B-I]")) %>%
  filter(!is.na(gender), !is.na(age), !is.na(race)) %>%
  pull(variable)

# to labelled
acscodes_df <- vars %>%
  mutate(race = str_to_upper(race)) %>%
  rename(gender_chr = gender, age_chr = age, educ_chr = educ, race_acs = race) %>%
  left_join(gender_key, by = "gender_chr") %>%
  left_join(age5_key, by = "age_chr") %>% # age 10 if using race interactions consider binding while keeping the label
  left_join(educ_key2, by = "educ_chr") %>%
  left_join(filter(race_key, !is.na(race_acs)), by = "race_acs") %>%
  select(variable, gender, age, educ, race)


# literal writeup -------
# (see above for more duplicate, source script)
acscodes_age_sex_educ <- c(
  "B15001_004",
  "B15001_005",
  "B15001_006",
  "B15001_007",
  "B15001_008",
  "B15001_009",
  "B15001_010",
  "B15001_012",
  "B15001_013",
  "B15001_014",
  "B15001_015",
  "B15001_016",
  "B15001_017",
  "B15001_018",
  "B15001_020",
  "B15001_021",
  "B15001_022",
  "B15001_023",
  "B15001_024",
  "B15001_025",
  "B15001_026",
  "B15001_028",
  "B15001_029",
  "B15001_030",
  "B15001_031",
  "B15001_032",
  "B15001_033",
  "B15001_034",
  "B15001_036",
  "B15001_037",
  "B15001_038",
  "B15001_039",
  "B15001_040",
  "B15001_041",
  "B15001_042",
  "B15001_045",
  "B15001_046",
  "B15001_047",
  "B15001_048",
  "B15001_049",
  "B15001_050",
  "B15001_051",
  "B15001_053",
  "B15001_054",
  "B15001_055",
  "B15001_056",
  "B15001_057",
  "B15001_058",
  "B15001_059",
  "B15001_061",
  "B15001_062",
  "B15001_063",
  "B15001_064",
  "B15001_065",
  "B15001_066",
  "B15001_067",
  "B15001_069",
  "B15001_070",
  "B15001_071",
  "B15001_072",
  "B15001_073",
  "B15001_074",
  "B15001_075",
  "B15001_077",
  "B15001_078",
  "B15001_079",
  "B15001_080",
  "B15001_081",
  "B15001_082",
  "B15001_083")

acscodes_age_sex_race <- c(
  "B01001B_007",
  "B01001B_008",
  "B01001B_009",
  "B01001B_010",
  "B01001B_011",
  "B01001B_012",
  "B01001B_013",
  "B01001B_014",
  "B01001B_015",
  "B01001B_016",
  "B01001B_022",
  "B01001B_023",
  "B01001B_024",
  "B01001B_025",
  "B01001B_026",
  "B01001B_027",
  "B01001B_028",
  "B01001B_029",
  "B01001B_030",
  "B01001B_031",
  "B01001C_007",
  "B01001C_008",
  "B01001C_009",
  "B01001C_010",
  "B01001C_011",
  "B01001C_012",
  "B01001C_013",
  "B01001C_014",
  "B01001C_015",
  "B01001C_016",
  "B01001C_022",
  "B01001C_023",
  "B01001C_024",
  "B01001C_025",
  "B01001C_026",
  "B01001C_027",
  "B01001C_028",
  "B01001C_029",
  "B01001C_030",
  "B01001C_031",
  "B01001D_007",
  "B01001D_008",
  "B01001D_009",
  "B01001D_010",
  "B01001D_011",
  "B01001D_012",
  "B01001D_013",
  "B01001D_014",
  "B01001D_015",
  "B01001D_016",
  "B01001D_022",
  "B01001D_023",
  "B01001D_024",
  "B01001D_025",
  "B01001D_026",
  "B01001D_027",
  "B01001D_028",
  "B01001D_029",
  "B01001D_030",
  "B01001D_031",
  "B01001E_007",
  "B01001E_008",
  "B01001E_009",
  "B01001E_010",
  "B01001E_011",
  "B01001E_012",
  "B01001E_013",
  "B01001E_014",
  "B01001E_015",
  "B01001E_016",
  "B01001E_022",
  "B01001E_023",
  "B01001E_024",
  "B01001E_025",
  "B01001E_026",
  "B01001E_027",
  "B01001E_028",
  "B01001E_029",
  "B01001E_030",
  "B01001E_031",
  "B01001F_007",
  "B01001F_008",
  "B01001F_009",
  "B01001F_010",
  "B01001F_011",
  "B01001F_012",
  "B01001F_013",
  "B01001F_014",
  "B01001F_015",
  "B01001F_016",
  "B01001F_022",
  "B01001F_023",
  "B01001F_024",
  "B01001F_025",
  "B01001F_026",
  "B01001F_027",
  "B01001F_028",
  "B01001F_029",
  "B01001F_030",
  "B01001F_031",
  "B01001G_007",
  "B01001G_008",
  "B01001G_009",
  "B01001G_010",
  "B01001G_011",
  "B01001G_012",
  "B01001G_013",
  "B01001G_014",
  "B01001G_015",
  "B01001G_016",
  "B01001G_022",
  "B01001G_023",
  "B01001G_024",
  "B01001G_025",
  "B01001G_026",
  "B01001G_027",
  "B01001G_028",
  "B01001G_029",
  "B01001G_030",
  "B01001G_031",
  "B01001H_007",
  "B01001H_008",
  "B01001H_009",
  "B01001H_010",
  "B01001H_011",
  "B01001H_012",
  "B01001H_013",
  "B01001H_014",
  "B01001H_015",
  "B01001H_016",
  "B01001H_022",
  "B01001H_023",
  "B01001H_024",
  "B01001H_025",
  "B01001H_026",
  "B01001H_027",
  "B01001H_028",
  "B01001H_029",
  "B01001H_030",
  "B01001H_031",
  "B01001I_007",
  "B01001I_008",
  "B01001I_009",
  "B01001I_010",
  "B01001I_011",
  "B01001I_012",
  "B01001I_013",
  "B01001I_014",
  "B01001I_015",
  "B01001I_016",
  "B01001I_022",
  "B01001I_023",
  "B01001I_024",
  "B01001I_025",
  "B01001I_026",
  "B01001I_027",
  "B01001I_028",
  "B01001I_029",
  "B01001I_030",
  "B01001I_031")


# Write ----
usethis::use_data(acscodes_age_sex_educ, overwrite = TRUE)
usethis::use_data(acscodes_age_sex_race, overwrite = TRUE)
usethis::use_data(acscodes_df, overwrite = TRUE)

